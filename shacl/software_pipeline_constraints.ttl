@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dob: <https://w3id.org/dob/voc#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

dob:SoftwarePipelineShape a sh:NodeShape ;
    sh:targetClass dob:SoftwarePipeline ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "A Software Pipeline can reference only one Code Revision per Code Repository."@en ;
        sh:select """
        SELECT $this
        WHERE {
            {
                SELECT ?repo (COUNT(?revision) AS ?count)
                WHERE {
                    $this dob:hasRevision ?revision .
                    ?revision dob:belongsToRepository ?repo .
                }
                GROUP BY ?repo
                HAVING (?count > 1)
            }
        }
        """ ;
    ] .
